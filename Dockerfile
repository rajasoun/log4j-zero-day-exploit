FROM maven AS build

COPY .   /log4j-zero-day-exploit
WORKDIR /log4j-zero-day-exploit

RUN set -x \
    && mvn -f log4j-exploit/pom.xml clean compile assembly:single \
    && mvn -f  jndi-exploit/pom.xml clean compile assembly:single 

########################################################################

FROM openjdk:11
# Defining default non-root user UID, GID, and name 
ARG USER_UID="1000"
ARG USER_GID="1000"
ARG USER_NAME="ci"
ENV TZ="Asia/Kolkata"
ENV HOME="/home/$USER_NAME"
ENV HOSTNAME="ci-shell"

# Creating default non-user 
RUN set -x \
    && groupadd -g $USER_GID $USER_NAME \
	&& useradd -m -g $USER_GID -u $USER_UID $USER_NAME

# Installing basic packages 
RUN set -x \
    && apt-get update  \
	&& apt-get install -y zip unzip curl  \
	&& rm -rf /var/lib/apt/lists/*  \
	&& rm -rf /tmp/*

# Switching to non-root user to install SDKMAN! 
USER $USER_UID:$USER_GID

WORKDIR /apps
COPY --from=build /log4j-zero-day-exploit/assist.sh /apps
COPY --from=build \
    /log4j-zero-day-exploit/log4j-exploit/target/log4j-exploit-1.0-SNAPSHOT-jar-with-dependencies.jar \ 
    /apps/log4j-exploit/target/log4j-exploit-1.0-SNAPSHOT-jar-with-dependencies.jar
COPY --from=build \
    /log4j-zero-day-exploit/jndi-exploit/target/jndi-exploit-1.0-SNAPSHOT-jar-with-dependencies.jar \ 
    /apps/jndi-exploit/target/jndi-exploit-1.0-SNAPSHOT-jar-with-dependencies.jar
    
ENTRYPOINT ["/bin/bash"]



